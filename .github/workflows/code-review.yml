name: SonarCloud + GPT + Comparaci√≥n

on:
  push:
    branches:
      - main

jobs:
  sonar-gpt-review:
    name: An√°lisis, Mejora y Comparaci√≥n
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del c√≥digo
        uses: actions/checkout@v3

      - name: Setup Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache de Maven
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven

      - name: Compilar y testear el proyecto
        run: mvn clean verify

      - name: An√°lisis original con SonarCloud (src/main/java)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn sonar:sonar \
            -Dsonar.projectKey=rodrigorojasg_testSpring \
            -Dsonar.organization=rodrigorojasg \
            -Dsonar.projectName="testSpring Original" \
            -Dsonar.sources=src/main/java \
            -Dsonar.tests=src/test \
            -Dsonar.java.binaries=target/classes \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.login=$SONAR_TOKEN

      - name: Guardar reporte original
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          curl -s "https://sonarcloud.io/api/issues/search?componentKeys=rodrigorojasg_testSpring&resolved=false" \
            -H "Authorization: Bearer $SONAR_TOKEN" > reporte_original.json

      - name: Detectar archivos con errores
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          curl -s "https://sonarcloud.io/api/issues/search?componentKeys=rodrigorojasg_testSpring&resolved=false" \
            -H "Authorization: Bearer $SONAR_TOKEN" |
            jq -r '.issues[].component' | sort -u > archivos_afectados.txt

      - name: Llamar a OpenAI por cada archivo afectado
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          while read COMPONENT; do
            FILE=$(echo "$COMPONENT" | sed 's/^rodrigorojasg_testSpring://')
            echo "Procesando: $FILE"

            if [ -f "$FILE" ]; then
              CODE=$(base64 "$FILE" | tr -d '\n')
              REPORT="Problemas detectados por SonarCloud en $COMPONENT"

              RESPONSE_FILE="gpt_response_$(basename $FILE .java).json"
              curl -s https://api.openai.com/v1/chat/completions \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -H "Content-Type: application/json" \
                -d '{
                  "model": "gpt-4",
                  "messages": [
                    {"role": "system", "content": "Eres un asistente experto en Java Spring Boot que mejora c√≥digo seg√∫n problemas de calidad."},
                    {"role": "user", "content": "Este es el c√≥digo fuente en base64: '"$CODE"'. A continuaci√≥n, los problemas reportados por SonarCloud: '"$REPORT"'. Corrige el c√≥digo aplicando mejoras que aborden los problemas mencionados, manteniendo la l√≥gica intacta. ‚ö†Ô∏è IMPORTANTE: responde √∫nicamente con el c√≥digo fuente corregido, sin ning√∫n texto adicional, comentario o encabezado."}
                  ],
                  "temperature": 0.3
                }' > "$RESPONSE_FILE"

              if jq -e '.choices[0].message.content' "$RESPONSE_FILE" > /dev/null 2>&1; then
                jq -r '.choices[0].message.content' "$RESPONSE_FILE" > "${FILE%.java}.mejorado.java"
                echo "‚úÖ Generado: ${FILE%.java}.mejorado.java"
              else
                echo "‚ùå Error con $FILE - respuesta inv√°lida"
                cat "$RESPONSE_FILE"
              fi
            else
              echo "‚ö†Ô∏è Archivo no encontrado: $FILE"
            fi
          done < archivos_afectados.txt

      - name: Preparar carpeta src-analizado/ con clases mejoradas
        run: |
          mkdir -p src-analizado/main/java
          for f in $(find . -name "*.mejorado.java"); do
            destino="src-analizado/$(echo $f | cut -d/ -f2- | sed 's/\.mejorado//')"
            mkdir -p $(dirname "$destino")
            cp "$f" "$destino"
          done

      - name: An√°lisis con SonarCloud del c√≥digo mejorado (src-analizado/main/java)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn sonar:sonar \
            -Dsonar.projectKey=rodrigorojasg_testSpring_gpt \
            -Dsonar.organization=rodrigorojasg \
            -Dsonar.projectName="testSpring GPT Mejorado" \
            -Dsonar.sources=src-analizado/main/java \
            -Dsonar.tests=src/test \
            -Dsonar.java.binaries=target/classes \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.login=$SONAR_TOKEN

      - name: Guardar reporte del c√≥digo mejorado
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          curl -s "https://sonarcloud.io/api/issues/search?componentKeys=rodrigorojasg_testSpring_gpt&resolved=false" \
            -H "Authorization: Bearer $SONAR_TOKEN" > reporte_mejorado.json

      - name: Comparar resultados de an√°lisis
        run: |
          echo "üìä Comparaci√≥n de errores:"
          echo "ANTES:"
          jq '.issues | group_by(.severity) | map({severity: .[0].severity, count: length})' reporte_original.json
          echo ""
          echo "DESPU√âS (mejorado):"
          jq '.issues | group_by(.severity) | map({severity: .[0].severity, count: length})' reporte_mejorado.json
